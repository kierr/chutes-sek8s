---
---
- name: Ensure namespaces exist
  kubernetes.core.k8s:
    name: "{{ item }}"
    api_version: v1
    kind: Namespace
    state: present
  loop:
    - gatekeeper-system

- name: Ensure K3s manifests directory exists
  ansible.builtin.file:
    path: /var/lib/rancher/k3s/server/manifests/gatekeeper
    state: directory
    owner: root
    group: root
    mode: '0700'

- name: Find generated Helm manifests
  ansible.builtin.find:
    paths: "{{ gatekeeper_manifest_dir }}"
    patterns: "*.yaml"
  register: helm_manifests

- name: Copy Helm-generated manifests to K3s manifests directory
  ansible.builtin.copy:
    src: "{{ item.path }}"
    dest: "/var/lib/rancher/k3s/server/manifests/gatekeeper/{{ item.path | basename }}"
    remote_src: yes
    owner: root
    group: root
    mode: '0600'
  loop: "{{ helm_manifests.files }}"
  notify: restart k3s

- name: Create custom Gatekeeper configuration overlay
  ansible.builtin.copy:
    src: manifests/gatekeeper-config-overlay.yaml
    dest: /var/lib/rancher/k3s/server/manifests/gatekeeper/gatekeeper-config-overlay.yaml
    owner: root
    group: root
    mode: '0600'
  notify: restart k3s

- name: Flush handlers to restart K3s before proceeding
  ansible.builtin.meta: flush_handlers

- name: Wait for K3s service to be running after restart
  ansible.builtin.systemd:
    name: k3s
  register: k3s_status
  until: k3s_status.status.ActiveState == "active"
  retries: 30
  delay: 5

- name: Protect all manifests from modification
  ansible.builtin.file:
    path: "/var/lib/rancher/k3s/server/manifests/gatekeeper/{{ item.path | basename }}"
    owner: root
    group: root
    mode: '0400'
    attributes: '+i'  # Immutable flag
  loop: "{{ helm_manifests.files }}"

- name: Protect custom config overlay
  ansible.builtin.file:
    path: /var/lib/rancher/k3s/server/manifests/gatekeeper/gatekeeper-config-overlay.yaml
    owner: root
    group: root
    mode: '0400'
    attributes: '+i'

- name: Cleanup Helm temporary files
  ansible.builtin.file:
    path: "{{ gatekeeper_helm_temp }}"
    state: absent