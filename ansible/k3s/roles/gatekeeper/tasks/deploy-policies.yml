---
- name: Wait for Gatekeeper deployment to be ready
  ansible.builtin.shell: |
    kubectl --kubeconfig=/etc/rancher/k3s/k3s.yaml get deployment gatekeeper-controller-manager -n gatekeeper-system -o jsonpath='{.status.readyReplicas}'
  register: gatekeeper_ready
  until: gatekeeper_ready.stdout | int > 0
  retries: 30
  delay: 10
  changed_when: false

- name: Wait for ConstraintTemplate CRD to be available
  ansible.builtin.shell: |
    kubectl --kubeconfig=/etc/rancher/k3s/k3s.yaml get crd constrainttemplates.templates.gatekeeper.sh
  register: crd_check
  until: crd_check.rc == 0
  retries: 30
  delay: 10
  changed_when: false

- name: Copy custom Gatekeeper policy templates
  ansible.builtin.copy:
    src: "policies/{{ item }}"
    dest: "/var/lib/rancher/k3s/server/manifests/gatekeeper/{{ item }}"
    owner: root
    group: root
    mode: '0600'
  loop:
    - blockpodexec-template.yaml
    - webhookprotection-template.yaml
  notify: restart k3s

- name: Flush handlers to restart K3s before proceeding
  ansible.builtin.meta: flush_handlers

- name: Wait for ConstraintTemplates to be processed
  ansible.builtin.shell: |
    kubectl --kubeconfig=/etc/rancher/k3s/k3s.yaml get constrainttemplate {{ item }} -o jsonpath='{.status.created}'
  register: template_status
  until: template_status.stdout == "true"
  retries: 30
  delay: 10
  changed_when: false
  loop:
    - blockpodexec
    - webhookprotection

- name: Copy custom Gatekeeper constraint files
  ansible.builtin.copy:
    src: "policies/{{ item }}"
    dest: "/var/lib/rancher/k3s/server/manifests/gatekeeper/{{ item }}"
    owner: root
    group: root
    mode: '0600'
  loop:
    - blockpodexec-constraint.yaml
    - webhookprotection-constraint.yaml

- name: Protect custom policy manifests
  ansible.builtin.file:
    path: /var/lib/rancher/k3s/server/manifests/gatekeeper/{{ item }}
    owner: root
    group: root
    mode: '0400'
    attributes: '+i'
  loop:
    - blockpodexec-template.yaml
    - webhookprotection-template.yaml
    - blockpodexec-constraint.yaml
    - webhookprotection-constraint.yaml