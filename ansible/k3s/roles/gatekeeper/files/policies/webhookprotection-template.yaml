---
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: webhookprotection
  labels:
    gatekeeper.sh/system: "yes"
spec:
  crd:
    spec:
      names:
        kind: WebhookProtection
      validation:
        openAPIV3Schema:
          type: object
          properties:
            protectedWebhooks:
              description: "List of webhook configurations that should be protected"
              type: array
              items:
                type: string
            allowedOperations:
              description: "Operations that are allowed on protected webhooks"
              type: array
              items:
                type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      code:
        - engine: Rego
          source:
            version: "v1"
            rego: |
              package webhookprotection

              violation contains {"msg": msg} if {
                  # Protect ValidatingAdmissionWebhook
                  input.review.kind.kind == "ValidatingAdmissionWebhook"
                  input.review.kind.group == "admissionregistration.k8s.io"
                  
                  # Check if this is a protected webhook
                  webhook_name := input.review.name
                  webhook_name in input.parameters.protectedWebhooks
                  
                  # Check if operation is not allowed
                  operation := input.review.operation
                  not operation in input.parameters.allowedOperations
                  
                  msg := sprintf("Operation '%s' on protected ValidatingAdmissionWebhook '%s' is not allowed", [operation, webhook_name])
              }

              violation contains {"msg": msg} if {
                  # Protect MutatingAdmissionWebhook
                  input.review.kind.kind == "MutatingAdmissionWebhook"
                  input.review.kind.group == "admissionregistration.k8s.io"
                  
                  # Check if this is a protected webhook
                  webhook_name := input.review.name
                  webhook_name in input.parameters.protectedWebhooks
                  
                  # Check if operation is not allowed
                  operation := input.review.operation
                  not operation in input.parameters.allowedOperations
                  
                  msg := sprintf("Operation '%s' on protected MutatingAdmissionWebhook '%s' is not allowed", [operation, webhook_name])
              }

              violation contains {"msg": msg} if {
                  # Protect Gatekeeper components
                  input.review.kind.kind in ["Deployment", "Service", "ServiceAccount", "ClusterRole", "ClusterRoleBinding", "Role", "RoleBinding"]
                  input.review.namespace == "gatekeeper-system"
                  input.review.operation in ["UPDATE", "DELETE"]
                  
                  # Check if object has gatekeeper system label
                  has_system_label
                  
                  msg := sprintf("Modification of Gatekeeper system component '%s/%s' is not allowed", [input.review.kind.kind, input.review.name])
              }

              violation contains {"msg": msg} if {
                  # Protect Gatekeeper CRDs
                  input.review.kind.kind == "CustomResourceDefinition"
                  input.review.kind.group == "apiextensions.k8s.io"
                  input.review.operation in ["UPDATE", "DELETE"]
                  
                  # Check if CRD is gatekeeper-related
                  crd_name := input.review.name
                  contains(crd_name, "gatekeeper.sh")
                  
                  msg := sprintf("Modification of Gatekeeper CRD '%s' is not allowed", [crd_name])
              }

              # Helper to check for gatekeeper system label
              has_system_label if {
                  input.review.object.metadata.labels["gatekeeper.sh/system"] == "yes"
              }