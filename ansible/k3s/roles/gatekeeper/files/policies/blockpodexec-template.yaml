---
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: blockpod
  labels:
    gatekeeper.sh/system: "yes"
spec:
  crd:
    spec:
      names:
        kind: BlockPod
      validation:
        openAPIV3Schema:
          type: object
          properties:
            exemptImages:
              description: "Any container that uses an image that matches an entry in this list will be excluded from enforcement."
              type: array
              items:
                type: string
            exemptNamespaces:
              description: "Any namespace listed here will be exempt from enforcement."
              type: array
              items:
                type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      code:
        - engine: Rego
          source:
            version: "v1"
            rego: |
              package blockpod

              # Block ALL exec operations
              violation contains {"msg": msg} if {
                  input.review.kind.kind == "PodExecOptions"
                  not is_exempt_namespace
                  msg := "Pod exec operations are not permitted."
              }

              # Block ALL attach operations
              violation contains {"msg": msg} if {
                  input.review.kind.kind == "PodAttachOptions"
                  not is_exempt_namespace
                  msg := "Pod attach operations are not permitted."
              }

              # Block ALL attach operations
              violation contains {"msg": msg} if {
                  input.review.kind.kind == "PodPortForwardOptions"
                  not is_exempt_namespace
                  msg := "Pod port forward operations are not permitted."
              }

              is_exempt_namespace if {
                  input.review.namespace in input.parameters.exemptNamespaces
              }

              is_exempt_namespace if {
                  # System namespaces are always exempt
                  input.review.namespace in ["kube-system", "gatekeeper-system", "kube-public", "kube-node-lease"]
              }