---
- name: Add Chutes Helm repository
  kubernetes.core.helm_repository:
    name: chutes
    repo_url: https://chutesai.github.io/chutes-miner

- name: Update Helm repositories
  shell: helm repo update

- name: Generate Chutes values file
  ansible.builtin.template:
    src: chutes-values.yaml.j2
    dest: /tmp/chutes-values.yaml
    mode: '0644'
  when: (chutes_gpu_values | default({}) | length) > 0

- name: Install or upgrade Chutes GPU charts
  ansible.builtin.shell: |
    helm upgrade --install chutes chutes/chutes-miner-gpu \
      --namespace chutes \
      --create-namespace \
      {% if chutes_chart_version is defined and chutes_chart_version %}
      --version {{ chutes_chart_version | quote }} \
      {% endif %}
      --set-string minerCredentials.ss58Address="REPLACE_ME" \
      --set-string minerCredentials.secretSeed="REPLACE_ME" \
      {% if (chutes_gpu_values | default({}) | length) > 0 %}
      -f /tmp/chutes-values.yaml \
      {% endif %}
      --kubeconfig=/etc/rancher/k3s/k3s.yaml
  register: miner_deployment
  changed_when: miner_deployment.rc == 0
  no_log: true

- name: Display deployment result
  ansible.builtin.debug:
    msg: "Miner GPU deployment on {{ inventory_hostname }}: {{ 'SUCCESS' if miner_deployment.rc == 0 else 'FAILED' }}"

- name: Delete dummy miner credentials
  kubernetes.core.k8s:
    name: miner-credentials
    api_version: v1
    kind: Secret
    namespace: chutes
    state: absent