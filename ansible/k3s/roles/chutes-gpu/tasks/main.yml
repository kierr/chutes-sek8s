---
- name: Wait for k3s API to be ready
  ansible.builtin.command:
    cmd: kubectl get --raw='/readyz'
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  retries: 30
  delay: 5
  register: api_ready
  until: api_ready.rc == 0

- name: Setup GPU operator
  ansible.builtin.include_tasks: setup_gpu_operator.yml
  tags: gpu-operator

- name: Setup monitoring
  ansible.builtin.include_tasks: setup_monitoring.yml
  tags: monitoring

- name: Setup chutes
  ansible.builtin.include_tasks: setup_chutes.yml
  tags: chutes