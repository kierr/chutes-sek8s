---
- name: Check if kernel supports module signatures
  shell: grep CONFIG_MODULE_SIG /boot/config-$(uname -r)
  register: module_sig_support
  changed_when: false
  failed_when: false

- name: Verify module signature support
  assert:
    that:
      - "'CONFIG_MODULE_SIG=y' in module_sig_support.stdout"
    fail_msg: "Kernel does not support module signatures"

- name: Deploy module security kernel parameters
  copy:
    src: 99-module-security.conf
    dest: /etc/sysctl.d/99-module-security.conf
    mode: '0644'
    owner: root
    group: root
  notify: reload sysctl

- name: Check if cloud image GRUB config exists
  stat:
    path: /etc/default/grub.d/50-cloudimg-settings.cfg
  register: cloud_grub

- name: Configure cloud GRUB kernel parameters
  lineinfile:
    path: /etc/default/grub.d/50-cloudimg-settings.cfg
    regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
    line: 'GRUB_CMDLINE_LINUX_DEFAULT="console=tty1 console=ttyS0"'
    backup: yes
  when: cloud_grub.stat.exists
  notify: update grub

- name: Configure standard GRUB kernel parameters
  lineinfile:
    path: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
    line: 'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"'
    backup: yes
  when: not cloud_grub.stat.exists
  notify: update grub

- name: Create module monitoring directory
  file:
    path: /etc/module-security
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Deploy module monitoring script
  copy:
    src: module-monitor/module-monitor.sh
    dest: /usr/local/bin/module-monitor.sh
    mode: '0755'
    owner: root
    group: root

- name: Deploy module monitor service files
  copy:
    src: "{{ item }}"
    dest: "/etc/systemd/system/{{ item | basename }}"
    mode: '0644'
  loop:
    - module-monitor/module-monitor.service
    - module-monitor/module-monitor.timer
  notify: reload systemd

- name: Enable and start module monitor timer
  systemd:
    name: module-monitor.timer
    enabled: yes
    state: started
    daemon_reload: yes

- name: Record current module state baseline
  shell: |
    lsmod | sort > /etc/module-security/modules.baseline
    find /lib/modules/$(uname -r) -name "*.ko*" -exec sha256sum {} \; | sort > /etc/module-security/module-files.sha256
  args:
    creates: /etc/module-security/modules.baseline

- name: Check module signature verification
  shell: |
    for mod in $(lsmod | tail -n +2 | awk '{print $1}'); do
      modinfo "$mod" | grep -E "^sig_" || echo "$mod: unsigned"
    done
  register: module_sig_check
  changed_when: false

- name: Save module signature status
  copy:
    content: "{{ module_sig_check.stdout }}"
    dest: /etc/module-security/signature-status.txt
    mode: '0644'

- name: Deploy log rotation configuration
  copy:
    src: module-monitor/module-monitor.logrotate
    dest: /etc/logrotate.d/module-monitor
    mode: '0644'
