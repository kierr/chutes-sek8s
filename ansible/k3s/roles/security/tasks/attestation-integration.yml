---
- name: Create attestation directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  loop:
    - /etc/attestation
    - /var/lib/attestation
    - /var/log/attestation

- name: Deploy module state collection script
  copy:
    src: module-attestation/collect-module-state.sh
    dest: /usr/local/bin/collect-module-state.sh
    mode: '0755'
    owner: root
    group: root

- name: Create attestation configuration
  template:
    src: attestation-config.yaml.j2
    dest: /etc/attestation/config.yaml
    mode: '0600'
    owner: root
    group: root

- name: Deploy attestation service
  copy:
    src: "{{ item }}"
    dest: "/etc/systemd/system/{{ item | basename }}"
    mode: '0644'
  loop:
    - module-attestation/module-attestation.service
    - module-attestation/module-attestation.timer
  notify: reload systemd

- name: Enable and start attestation timer
  systemd:
    name: module-attestation.timer
    enabled: yes
    state: started
    daemon_reload: yes