#include <tunables/global>

profile containerd-restrictions flags=(attach_disconnected) {
  #include <abstractions/base>
  
  capability,
  
  # Containerd binaries
  /usr/bin/containerd* ix,
  /usr/local/bin/containerd* ix,
  /usr/bin/runc ix,
  /usr/sbin/runc ix,
  
  # Containerd runtime directories
  /run/containerd/** rwk,
  /var/lib/containerd/** rwk,
  /var/lib/rancher/k3s/agent/containerd/** rwk,
  
  # System access
  /proc/** r,
  /sys/** r,
  /dev/** rw,
  
  # Only allow specific mount types for container operations
  mount fstype=overlay,
  mount fstype=tmpfs,
  mount fstype=proc,
  mount fstype=sysfs,
  mount fstype=cgroup,
  mount fstype=cgroup2,
  mount fstype=devpts,
  mount fstype=mqueue,
  
  # Only allow bind mounts from /cache to specific container-related paths
  mount options=(rw,bind) /cache/ -> /var/lib/kubelet/pods/*/volumes/**,
  mount options=(rw,bind) /cache/** -> /var/lib/kubelet/pods/*/volumes/**,
  mount options=(ro,bind) /cache/ -> /var/lib/kubelet/pods/*/volumes/**,
  mount options=(ro,bind) /cache/** -> /var/lib/kubelet/pods/*/volumes/**,
  
  mount options=(rw,bind) /cache/ -> /var/lib/rancher/k3s/storage/**,
  mount options=(rw,bind) /cache/** -> /var/lib/rancher/k3s/storage/**,
  mount options=(ro,bind) /cache/ -> /var/lib/rancher/k3s/storage/**,
  mount options=(ro,bind) /cache/** -> /var/lib/rancher/k3s/storage/**,
  
  mount options=(rw,bind) /cache/ -> /run/containerd/io.containerd.runtime.*/k3s.io/*/rootfs/**,
  mount options=(rw,bind) /cache/** -> /run/containerd/io.containerd.runtime.*/k3s.io/*/rootfs/**,
  mount options=(ro,bind) /cache/ -> /run/containerd/io.containerd.runtime.*/k3s.io/*/rootfs/**,
  mount options=(ro,bind) /cache/** -> /run/containerd/io.containerd.runtime.*/k3s.io/*/rootfs/**,
  
  # Deny bind mounts from other sources
  deny mount options=(rw,bind) /etc/** -> /**,
  deny mount options=(rw,bind) /var/** -> /**,
  deny mount options=(rw,bind) /usr/** -> /**,
  deny mount options=(rw,bind) /opt/** -> /**,
  deny mount options=(rw,bind) /home/** -> /**,
  deny mount options=(rw,bind) /root/** -> /**,
  deny mount options=(ro,bind) /etc/** -> /**,
  deny mount options=(ro,bind) /var/** -> /**,
  deny mount options=(ro,bind) /usr/** -> /**,
  deny mount options=(ro,bind) /opt/** -> /**,
  deny mount options=(ro,bind) /home/** -> /**,
  deny mount options=(ro,bind) /root/** -> /**,
  
  # Allow umount
  umount,
  
  # Allow pivot_root for container creation
  pivot_root,
  
  # Allow everything else for containerd operation
  /** rwk,
}