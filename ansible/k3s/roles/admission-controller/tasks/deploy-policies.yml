---
- name: Deploy OPA policies
  block:
    - name: Copy OPA policy files
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: /etc/opa/policies/
        owner: root
        group: root
        mode: '0644'
      with_fileglob:
        - "files/policies/*.rego"
      register: policy_files

    - name: Validate OPA policies (opa check; policy tests live in tests/opa, run locally)
      ansible.builtin.command:
        cmd: opa check /etc/opa/policies
      changed_when: false
      register: policy_check

    - name: Display policy check result
      ansible.builtin.debug:
        msg: "{{ policy_check.stdout }}"
      when: policy_check.stdout | length > 0