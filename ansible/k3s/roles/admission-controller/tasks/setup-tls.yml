---
- name: Setup TLS certificates for admission webhook
  block:
    - name: Check if certificates already exist
      ansible.builtin.stat:
        path: /etc/admission-controller/certs/server.crt
      register: cert_exists

    - name: Generate self-signed certificates
      when: not cert_exists.stat.exists
      block:
        - name: Generate private key
          ansible.builtin.command:
            cmd: openssl genrsa -out /etc/admission-controller/certs/server.key 2048
            creates: /etc/admission-controller/certs/server.key

        - name: Create OpenSSL config for certificate with SANs
          ansible.builtin.copy:
            content: |
              [req]
              distinguished_name = req_distinguished_name
              req_extensions = v3_req
              prompt = no
              
              [req_distinguished_name]
              CN = admission-controller
              
              [v3_req]
              keyUsage = keyEncipherment, dataEncipherment
              extendedKeyUsage = serverAuth
              subjectAltName = @alt_names
              
              [alt_names]
              DNS.1 = admission-controller
              DNS.2 = admission-controller.kube-system.svc
              DNS.3 = admission-controller.kube-system.svc.cluster.local
              DNS.4 = localhost
              IP.1 = 127.0.0.1
              IP.2 = ::1
              IP.3 = {{ ansible_default_ipv4.address | default('127.0.0.1') }}
            dest: /etc/admission-controller/certs/openssl.cnf
            owner: root
            group: root
            mode: '0644'

        - name: Generate certificate signing request with SANs
          ansible.builtin.command:
            cmd: >-
              openssl req -new
              -key /etc/admission-controller/certs/server.key
              -out /etc/admission-controller/certs/server.csr
              -config /etc/admission-controller/certs/openssl.cnf
            creates: /etc/admission-controller/certs/server.csr

        - name: Generate self-signed certificate with SANs
          ansible.builtin.command:
            cmd: >-
              openssl x509 -req -days 365
              -in /etc/admission-controller/certs/server.csr
              -signkey /etc/admission-controller/certs/server.key
              -out /etc/admission-controller/certs/server.crt
              -extensions v3_req
              -extfile /etc/admission-controller/certs/openssl.cnf
            creates: /etc/admission-controller/certs/server.crt

    - name: Set certificate permissions
      ansible.builtin.file:
        path: "{{ item }}"
        owner: root
        group: admission
        mode: '0640'
      loop:
        - /etc/admission-controller/certs/server.key
        - /etc/admission-controller/certs/server.crt

    - name: Read certificate for webhook configuration
      ansible.builtin.slurp:
        src: /etc/admission-controller/certs/server.crt
      register: webhook_cert

    - name: Store certificate in fact for webhook configuration
      ansible.builtin.set_fact:
        admission_webhook_ca_bundle: "{{ webhook_cert.content }}"