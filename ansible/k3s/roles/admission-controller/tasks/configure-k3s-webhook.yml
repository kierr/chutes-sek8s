- name: Configure K3s admission webhook with RBAC lockdown
  block:
    - name: Ensure K3s manifests directory exists
      ansible.builtin.file:
        path: /var/lib/rancher/k3s/server/manifests
        state: directory
        owner: root
        group: root
        mode: '0700'

    - name: Create external webhook manifest
      ansible.builtin.template:
        src: admission-webhook.yaml.j2
        dest: /var/lib/rancher/k3s/server/manifests/admission-webhook.yaml
        owner: root
        group: root
        mode: '0600'
      vars:
        admission_webhook_config:
          webhook_name: admission-controller-webhook
          port: "{{ admission_port | default(8443) }}"
          localhost: true
      notify: restart k3s

    - name: Protect webhook manifest from modifications
      ansible.builtin.file:
        path: /var/lib/rancher/k3s/server/manifests/admission-webhook.yaml
        owner: root
        group: root
        mode: '0400'  # Read-only
        attributes: '+i'  # Immutable flag (requires root to remove)
