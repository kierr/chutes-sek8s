# ansible/k3s/roles/admission-controller/tasks/setup_gatekeeper.yml
---
- name: Setup Gatekeeper for mutual protection
  block:
    - name: Add Gatekeeper Helm repository
      kubernetes.core.helm_repository:
        name: gatekeeper
        repo_url: https://open-policy-agent.github.io/gatekeeper/charts

    - name: Create Gatekeeper namespace
      kubernetes.core.k8s:
        name: gatekeeper-system
        api_version: v1
        kind: Namespace
        state: present
        definition:
          metadata:
            labels:
              admission.gatekeeper.sh/ignore: "true"  # Self-exemption during bootstrap
              pod-security.kubernetes.io/enforce: privileged
              pod-security.kubernetes.io/audit: privileged
              pod-security.kubernetes.io/warn: privileged

    - name: Create Gatekeeper values file
      ansible.builtin.copy:
        src: files/gatekeeper-values.yaml
        dest: /tmp/gatekeeper-values.yaml
        mode: '0644'

    - name: Install Gatekeeper using Helm
      kubernetes.core.helm:
        name: gatekeeper
        chart_ref: gatekeeper/gatekeeper
        release_namespace: gatekeeper-system
        create_namespace: false
        values_files:
          - /tmp/gatekeeper-values.yaml
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 300

    - name: Wait for Gatekeeper controller to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: gatekeeper-controller-manager
        namespace: gatekeeper-system
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 300

    - name: Wait for Gatekeeper audit to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: gatekeeper-audit
        namespace: gatekeeper-system
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 300

    - name: Apply Gatekeeper constraint templates
      kubernetes.core.k8s:
        definition: "{{ item }}"
        state: present
      loop:
        - "{{ gatekeeper_block_exec_template }}"
        - "{{ gatekeeper_protect_webhooks_template }}"
        - "{{ gatekeeper_protect_gatekeeper_template }}"
      vars:
        gatekeeper_block_exec_template: "{{ lookup('file', 'gatekeeper/constraint-templates/block-exec-template.yaml') | from_yaml }}"
        gatekeeper_protect_webhooks_template: "{{ lookup('file', 'gatekeeper/constraint-templates/protect-webhooks-template.yaml') | from_yaml }}"
        gatekeeper_protect_gatekeeper_template: "{{ lookup('file', 'gatekeeper/constraint-templates/protect-gatekeeper-template.yaml') | from_yaml }}"

    - name: Wait for constraint templates to be established
      kubernetes.core.k8s_info:
        api_version: apiextensions.k8s.io/v1
        kind: CustomResourceDefinition
        name: "{{ item }}.constraints.gatekeeper.sh"
        wait: true
        wait_condition:
          type: Established
          status: "True"
        wait_timeout: 60
      loop:
        - blockexecattach
        - protectwebhooks
        - protectgatekeeper

    - name: Apply Gatekeeper constraints
      kubernetes.core.k8s:
        definition: "{{ lookup('file', item) | from_yaml }}"
        state: present
      loop:
        - files/gatekeeper/constraints/block-exec.yaml
        - files/gatekeeper/constraints/protect-webhooks.yaml
        - files/gatekeeper/constraints/protect-gatekeeper.yaml

    - name: Wait for constraints to be ready
      kubernetes.core.k8s_info:
        api_version: constraints.gatekeeper.sh/v1beta1
        kind: "{{ item.kind }}"
        name: "{{ item.name }}"
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 60
      loop:
        - { kind: "BlockExecAttach", name: "block-all-exec-attach" }
        - { kind: "ProtectWebhooks", name: "protect-admission-webhook" }
        - { kind: "ProtectGatekeeper", name: "protect-gatekeeper-resources" }