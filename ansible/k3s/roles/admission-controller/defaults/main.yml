# ansible/k3s/roles/admission-controller/defaults/main.yml

# Git repository settings
admission_controller_repo: "https://github.com/rayonlabs/sek8s.git"
admission_controller_version: "admission-controller"
update_repository: true
update_dependencies: false

# OPA settings
opa_version: "0.68.0"
opa_log_level: "info"
opa_decision_logs: false

# Admission controller settings
admission_bind_address: "127.0.0.1"
admission_port: 8443
enforcement_mode: "enforce"
cache_enabled: true
cache_ttl: 300
debug_mode: false
metrics_enabled: true

# Registry allowlist
allowed_registries:
  - docker.io
  - gcr.io
  - quay.io
  - localhost:30500

# Run validation tests after deployment
run_validation_tests: true

# Gatekeeper settings
enable_gatekeeper: true
gatekeeper_chart_version: "3.14.0"
gatekeeper_namespace: "gatekeeper-system"

# Emergency access configuration
emergency_users: []
# Example:
# emergency_users:
#   - "system:serviceaccount:kube-system:admin"
#   - "custom-emergency-user"

# Additional protected webhooks (beyond the defaults)
additional_protected_webhooks: []
# Example:
# additional_protected_webhooks:
#   - "custom-webhook-config"

# Additional protected services (beyond the defaults)
additional_protected_services: []
# Example:
# additional_protected_services:
#   - name: "custom-service"
#     namespace: "custom-namespace"

# Monitoring and alerting
enable_health_monitoring: true
health_check_interval: 600  # 10 minutes
alert_webhook: ""  # Optional webhook URL for alerts
# Example:
# alert_webhook: "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"

# Bootstrap and recovery settings
bootstrap_timeout: 300  # 5 minutes
verification_timeout: 120  # 2 minutes

# Gatekeeper resource settings
gatekeeper_controller_resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 256Mi

gatekeeper_audit_resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 256Mi

# Gatekeeper constraint configuration - focused on core needs
gatekeeper_constraints:
  # Core constraints (always applied if Gatekeeper enabled)
  exec_blocking: true                    # Block exec/attach operations
  webhook_protection: true              # Protect admission webhooks
  
  # Optional constraints
  self_protection: false                 # Let external controller handle this
  service_protection: false             # Not needed for localhost-based external controller
  
# Minimal mode - only sync and protect what's absolutely necessary
gatekeeper_minimal_mode: true          # Only sync Pods and ValidatingWebhookConfigurations

# Constraint violation limits
constraint_violations_limit: 20

# Exempted namespaces for specific constraints (use with caution)
exec_block_exempt_namespaces: []
webhook_protection_exempt_namespaces: []

# Advanced settings
enable_mutation: false  # Enable Gatekeeper mutation (future use)
enable_external_data: false  # Enable external data providers
enable_generator_expansion: true
enable_tls_healthcheck: true

# Audit settings
gatekeeper_audit_interval: 60
gatekeeper_audit_from_cache: false

# Metrics and observability
enable_prometheus_metrics: true
enable_constraint_violations_logging: true
enable_decision_logging: false

# Pod disruption budget
enable_pod_disruption_budget: true
min_available_replicas: 1

# Priority class
use_system_cluster_critical: true