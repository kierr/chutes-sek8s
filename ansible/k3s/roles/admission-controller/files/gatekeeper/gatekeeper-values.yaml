# ansible/k3s/roles/admission-controller/templates/gatekeeper-values.yaml.j2
# Gatekeeper Helm chart values
replicas: 1
revisionHistoryLimit: 3

postInstall:
  labelNamespace:
    enabled: true

image:
  repository: openpolicyagent/gatekeeper
  tag: v3.14.0
  pullPolicy: IfNotPresent

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 256Mi

nodeSelector: {}
tolerations: []
affinity: {}

# Security context
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  runAsGroup: 999
  runAsNonRoot: true
  runAsUser: 1000

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 999
  fsGroup: 999

# Webhook configuration
webhook:
  certDir: /certs
  port: 8443
  timeoutSeconds: 3
  failurePolicy: Fail
  namespaceSelector:
    matchExpressions:
    - key: name
      operator: NotIn
      values: ["gatekeeper-system"]

# Enable mutations (for future use)
enableExternalData: false
enableGeneratorResourceExpansion: true
enableTLSHealthcheck: true

# Audit configuration
audit:
  replicas: 1
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi
  
  # Audit interval
  auditInterval: 60
  
  # Log violations
  logLevel: INFO
  
  # Audit from cache
  auditFromCache: false

# Controller manager configuration
controllerManager:
  exemptNamespaces:
  - gatekeeper-system
  - kube-system
  
  # Metrics
  metricsBackends: ["prometheus"]
  
  # Health probe configuration
  healthPort: 9090
  
  # Log level
  logLevel: INFO
  
  # Resource limits for the controller
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi

# Enable deletion protection
enableDeleteOperations: true

# Validation configuration
validatingAdmissionPolicies:
  enabled: false

# Constraint evaluation
constraintViolationsLimit: 20

# Experiment with external data providers (disabled for now)
externalDataProviders: []

# Logging configuration
logLevel: INFO
logDenies: true

# Metric configuration  
metricsBackends:
- prometheus

# Readiness and liveness probes
readinessProbe:
  httpGet:
    path: /readyz
    port: 9090
  initialDelaySeconds: 5
  periodSeconds: 10

livenessProbe:
  httpGet:
    path: /healthz
    port: 9090
  initialDelaySeconds: 15
  periodSeconds: 20

# Pod disruption budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Priority class
priorityClassName: system-cluster-critical

# Enable mutation (can be used for automatic security enhancements)
mutation:
  enabled: false

# Gatekeeper configuration
config:
  # Validation configuration
  validation:
    traces:
    - user:
        name: "{{ ansible_user | default('admin') }}"
      kind:
        name: "*"
  
  # Match configuration - apply to all resources except exempted namespaces
  match:
  - excludedNamespaces: ["gatekeeper-system", "kube-system"]
    processes: ["*"]
  
  # Readiness configuration
  readiness:
    statsEnabled: true
  
  sync:
    # Minimal sync - only what's needed for exec blocking and webhook protection
    syncOnly:
    - group: ""
      version: "v1"
      kind: "Pod"
    - group: "admissionregistration.k8s.io"
      version: "v1"
      kind: "ValidatingWebhookConfiguration"

# Service monitor for Prometheus (if available)
serviceMonitor:
  enabled: false

# Network policies (if needed)
networkPolicy:
  enabled: false