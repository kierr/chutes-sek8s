[Unit]
Description=Containerd cache storage
Documentation=man:systemd.mount(5)
# This mount unit runs after device is available
After=local-fs-pre.target systemd-udev-settle.service
# Must be mounted before containerd and k3s
Before=containerd.service
Before=k3s.service
Before=k3s-agent.service

[Mount]
{% if debug_build | default(false) %}
# Debug mode: Use unencrypted device by label
What=/dev/disk/by-label/containerd-cache
{% else %}
# Production mode: Use the mapped LUKS device (unlocked by initramfs)
What=/dev/mapper/containerd_cache
{% endif %}
Where=/var/lib/rancher/k3s/agent/containerd
Type=ext4
Options=defaults,noatime
# Don't allow boot to continue if mount fails
TimeoutSec=30

[Install]
WantedBy=local-fs.target
