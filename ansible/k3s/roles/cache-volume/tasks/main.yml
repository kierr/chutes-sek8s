---
# ansible-deploy-cache-volume.yml
# Ansible playbook to deploy cache volume verification and mount services
# to a TDX guest VM during the build process.
#
# Usage:
#   ansible-playbook -i inventory.yml ansible-deploy-cache-volume.yml
#
# This playbook:
#   1. Copies the verification script to /usr/local/bin/
#   2. Installs the systemd service units
#   3. Enables (but does not start) the services
#   4. Creates the /var/snap mount point directory
#
# The services will automatically start on next boot when the cache volume
# is attached to the VM.

- name: Deploy cache volume verification and mount services
  vars:
    # Path to the files on the Ansible control node
    files_dir: "files"
  block:
    - name: Ensure /usr/local/bin exists
      file:
        path: /usr/local/bin
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Copy cache volume verification script (post-mount encryption state)
      copy:
        src: "{{ files_dir }}/verify-cache-volume.sh"
        dest: /usr/local/bin/verify-cache-volume.sh
        mode: '0755'
        owner: root
        group: root
      register: verify_script

    - name: Template verify cache volume service
      template:
        src: verify-cache-volume.service.j2
        dest: /etc/systemd/system/verify-cache-volume.service
        mode: '0644'
        owner: root
        group: root
      register: verify_service

    - name: Template var-snap mount unit
      template:
        src: var-snap.mount.j2
        dest: /etc/systemd/system/var-snap.mount
        mode: '0644'
        owner: root
        group: root
      register: var_snap_mount_unit

    - name: Template cache storage mount unit
      template:
        src: cache-storage.mount.j2
        dest: /etc/systemd/system/cache-storage.mount
        mode: '0644'
        owner: root
        group: root
      register: cache_storage_mount_unit

    - name: Copy verify storage script
      copy:
        src: "{{ files_dir }}/verify-storage.sh"
        dest: /usr/local/bin/verify-storage.sh
        mode: '0755'
        owner: root
        group: root
      register: verify_storage_script

    - name: Template verify storage service
      template:
        src: verify-storage.service.j2
        dest: /etc/systemd/system/verify-storage.service
        mode: '0644'
        owner: root
        group: root
      register: verify_storage_service

    - name: Copy cache setup script
      copy:
        src: "{{ files_dir }}/setup-cache.sh"
        dest: /usr/local/bin/setup-cache.sh
        mode: '0755'
        owner: root
        group: root
      register: cache_script

    - name: Copy cache setup service
      copy:
        src: "{{ files_dir }}/setup-cache.service"
        dest: /etc/systemd/system/setup-cache.service
        mode: '0644'
        owner: root
        group: root
      register: cache_service

    - name: Copy storage bind mounts setup script
      copy:
        src: "{{ files_dir }}/setup-storage-bind-mounts.sh"
        dest: /usr/local/bin/setup-storage-bind-mounts.sh
        mode: '0755'
        owner: root
        group: root
      register: storage_bind_mounts_script

    - name: Copy storage bind mounts service
      copy:
        src: "{{ files_dir }}/setup-storage-bind-mounts.service"
        dest: /etc/systemd/system/setup-storage-bind-mounts.service
        mode: '0644'
        owner: root
        group: root
      register: storage_bind_mounts_service

    - name: Reload systemd daemon if units changed
      systemd:
        daemon_reload: yes
      when: verify_service.changed or var_snap_mount_unit.changed or cache_storage_mount_unit.changed or verify_storage_service.changed or cache_service.changed or storage_bind_mounts_service.changed

    - name: Create /var/snap mount point directory
      file:
        path: /var/snap
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Create /cache directory
      file:
        path: /cache
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Create containerd cache mount point directory
      file:
        path: /var/lib/rancher/k3s/agent/containerd
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Create kubelet parent directory
      file:
        path: /var/lib/kubelet
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Ensure Chutes agent parent directory exists
      file:
        path: /var/lib/chutes
        state: directory
        mode: '0755'
        owner: root
        group: root

    # setup-cache.service sets /var/snap/cache permissions at boot; setup-storage-bind-mounts creates agent dir and bind mount on main storage

    - name: Enable verify-cache-volume.service (but do not start)
      systemd:
        name: verify-cache-volume.service
        enabled: yes
        state: stopped
        daemon_reload: yes
      # Use failed_when to handle the case where service can't start in build VM
      # (because /dev/vdb doesn't exist yet)
      failed_when: false

    - name: Enable var-snap.mount (but do not start)
      systemd:
        name: var-snap.mount
        enabled: yes
        state: stopped
        daemon_reload: yes
      failed_when: false

    - name: Enable cache storage mount (but do not start)
      systemd:
        name: cache-storage.mount
        enabled: yes
        state: stopped
        daemon_reload: yes
      failed_when: false

    # Don't enable by default during multi-phase builds. Let cleanup/enable step enable it.
    - name: Set verify storage service state (disabled during build)
      systemd:
        name: verify-storage.service
        enabled: no
        state: stopped
        daemon_reload: yes
      failed_when: false

    - name: Enable cache setup service (but do not start)
      systemd:
        name: setup-cache.service
        enabled: yes
        state: stopped
        daemon_reload: yes
      failed_when: false

    - name: Enable storage bind mounts service (but do not start)
      systemd:
        name: setup-storage-bind-mounts.service
        enabled: yes
        state: stopped
        daemon_reload: yes
      failed_when: false

    - name: Verify installation
      command: systemctl is-enabled verify-cache-volume.service
      register: service_status
      changed_when: false
      failed_when: service_status.rc != 0

    - name: Verify mount unit installation
      command: systemctl is-enabled var-snap.mount
      register: mount_status
      changed_when: false
      failed_when: mount_status.stdout != "enabled"

    - name: Verify cache storage mount unit installation
      command: systemctl is-enabled cache-storage.mount
      register: cache_storage_mount_status
      changed_when: false
      failed_when: cache_storage_mount_status.stdout != "enabled"

    - name: Verify verify storage service installation (disabled during build, will be enabled in cleanup)
      command: systemctl is-enabled verify-storage.service
      register: verify_storage_status
      changed_when: false
      failed_when: verify_storage_status.stdout != "disabled"

    - name: Verify cache setup service installation
      command: systemctl is-enabled setup-cache.service
      register: cache_status
      changed_when: false
      failed_when: cache_status.stdout != "enabled"

    - name: Verify storage bind mounts service installation
      command: systemctl is-enabled setup-storage-bind-mounts.service
      register: storage_bind_mounts_status
      changed_when: false
      failed_when: storage_bind_mounts_status.stdout != "enabled"