- name: Ensure NVIDIA tools are present (basic check)
  command: which nvidia-smi
  register: nvidia_smi_check
  changed_when: false
  failed_when: nvidia_smi_check.rc != 0
  tags: check

- name: Create GPU verification script directory
  file:
    path: /usr/local/bin
    state: directory
    mode: '0755'
  tags: script

- name: Deploy GPU verification script
  copy:
    src: gpu-verify.sh
    dest: "{{ gpu_verify_script_path }}"
    mode: '0755'
  register: script_created
  tags: script

- name: Create GPU verify environment file directory
  ansible.builtin.file:
    path: "{{ gpu_verify_env_file_path | dirname }}"
    state: directory
    mode: '0755'

- name: Deploy GPU verify environment file
  ansible.builtin.template:
    src: gpu-verify.env.j2
    dest: "{{ gpu_verify_env_file_path }}"
    mode: '0644'
    owner: root
    group: root

- name: Create systemd service unit file for GPU verification
  ansible.builtin.template:
    src: gpu-verify.service.j2
    dest: /etc/systemd/system/{{ gpu_verify_service_name }}
    mode: '0644'
  register: service_created
  tags: service

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  when: service_created.changed
  tags: service

# Don't enable by default during multi-phase builds. Let cleanup/enable step enable it.
- name: Set GPU verify service state
  systemd:
    name: "{{ gpu_verify_service_name }}"
    enabled: no
    state: stopped
  tags: service
