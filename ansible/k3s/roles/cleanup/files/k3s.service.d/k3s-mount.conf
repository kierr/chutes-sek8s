[Unit]
# Ensure k3s doesn't start until storage is mounted and bind mounts are created.
# This is added at runtime (cleanup phase) because the storage volume doesn't exist during build.
# Requires= ensures k3s fails if bind mount setup fails (After= alone only controls ordering).
Requires=setup-storage-bind-mounts.service
After=setup-storage-bind-mounts.service

[Service]
# On system shutdown/reboot, kill orphaned containerd-shim processes before systemd
# considers k3s.service fully stopped. k3s uses KillMode=process so only the main
# process gets SIGTERM; container shims (in kubepods.slice cgroup scopes) survive and
# hold file descriptors open on /var/lib/rancher/k3s, preventing the bind mount from
# unmounting cleanly. The is-system-running check ensures this only fires during
# shutdown â€” not during a normal k3s restart where containers should survive.
ExecStopPost=-/bin/bash -c '\
  if [ "$(systemctl is-system-running 2>/dev/null)" = "stopping" ]; then \
    pkill containerd-shim 2>/dev/null || true; \
    sleep 2; \
    pkill -9 containerd-shim 2>/dev/null || true; \
  fi'
