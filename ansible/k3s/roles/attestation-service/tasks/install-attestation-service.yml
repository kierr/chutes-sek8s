---
- name: Create environment file for attestation service
  ansible.builtin.template:
    src: attestation-service.env.j2
    dest: /etc/attestation-service/attestation-service.env
    owner: root
    group: tdx-attest
    mode: '0640'

- name: Configure log rotation for attestation service
  ansible.builtin.copy:
    content: |
      /var/log/attestation-service/*.log {
          daily
          rotate 30
          compress
          delaycompress
          missingok
          notifempty
          create 644 tdx-attest tdx-attest
          postrotate
              systemctl reload attestation-service
          endscript
      }
    dest: /etc/logrotate.d/attestation-service
    owner: root
    group: root
    mode: '0644'

- name: Create attestation systemd service
  ansible.builtin.copy:
    src: attestation-service.service
    dest: /etc/systemd/system/attestation-service.service
    owner: root
    group: root
    mode: '0644'

- name: Create attestation service override directory
  ansible.builtin.file:
    path: /etc/systemd/system/attestation-service.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create security hardening drop-in
  ansible.builtin.copy:
    src: attestation-service.conf
    dest: /etc/systemd/system/attestation-service.service.d/10-security.conf
    owner: root
    group: root
    mode: '0644'

- name: Enable and start attestation service
  ansible.builtin.systemd:
    name: attestation-service.service
    enabled: yes
    state: started
    daemon_reload: yes

- name: Check attestation service init status
  ansible.builtin.systemd:
    name: attestation-service-init.service
  register: init_service_status

- name: Check main attestation service status
  ansible.builtin.systemd:
    name: attestation-service.service
  register: main_service_status

- name: Display service status
  ansible.builtin.debug:
    msg:
      - "Init service status: {{ init_service_status.status.ActiveState }}"
      - "Main service status: {{ main_service_status.status.ActiveState }}"

- name: Wait for attestation service to be ready
  ansible.builtin.uri:
    url: http://localhost/health
    unix_socket: /run/attestation-service/attestation.sock
    status_code: 200
  register: attestation_health
  until: attestation_health.status == 200
  retries: 30
  delay: 2