---
- name: Ensure supplemental groups exist for system status
  ansible.builtin.group:
    name: "{{ item }}"
    state: present
    system: yes
  loop:
    - systemd-journal
    - video

- name: Ensure tdx-attest group exists for TLS sharing
  ansible.builtin.group:
    name: tdx-attest
    gid: 987
    state: present
    system: yes

- name: Create system status user
  ansible.builtin.user:
    name: status
    system: yes
    shell: /usr/sbin/nologin
    create_home: no
    groups: "sek8s,systemd-journal,video,tdx-attest"
    append: yes
    home: /opt/sek8s

- name: Create directories for system status service
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: /etc/system-status, owner: root, group: status, mode: '0750' }
    - { path: /var/log/system-status, owner: status, group: status, mode: '0750' }

- name: Deploy environment file
  ansible.builtin.template:
    src: system-status.env.j2
    dest: /etc/system-status/system-status.env
    owner: root
    group: status
    mode: '0640'

- name: Install system status service
  ansible.builtin.copy:
    src: system-status.service
    dest: /etc/systemd/system/system-status.service
    owner: root
    group: root
    mode: '0644'

- name: Create system status drop-in directory
  ansible.builtin.file:
    path: /etc/systemd/system/system-status.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Deploy security drop-in
  ansible.builtin.copy:
    src: system-status.conf
    dest: /etc/systemd/system/system-status.service.d/10-security.conf
    owner: root
    group: root
    mode: '0644'

- name: Enable and start system status
  ansible.builtin.systemd:
    name: system-status.service
    enabled: yes
    state: started
    daemon_reload: yes
